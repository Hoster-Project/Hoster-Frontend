name: Deploy Frontend

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: SSH and Deploy Frontend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          sync: true
          script: |
            # 1. Setup paths
            NODE_PATH=/home/ubuntu/.nvm/versions/node/v25.6.1/bin
            PROJECT_ROOT=${{ secrets.PROJECT_PATH }}
            
            cd $PROJECT_ROOT

            # 2. Update Code
            echo "Pulling latest code..."
            git pull origin main

            # 3. Clean Install & Build
            echo "Installing dependencies..."
            $NODE_PATH/npm install
            
            echo "Starting build process..."
            # Using --max-old-space-size to prevent memory crashes during build
            NODE_OPTIONS="--max-old-space-size=1024" $NODE_PATH/npm run build

            # 4. Verify Build Success
            if [ ! -d ".next" ]; then
                echo "ERROR: .next directory not found. Build failed."
                exit 1
            fi

            # 5. Restart PM2
            echo "Restarting PM2..."
            if $NODE_PATH/pm2 describe hoster-frontend > /dev/null 2>&1; then
                $NODE_PATH/pm2 reload hoster-frontend --update-env
            else
                # We use --cwd to ensure PM2 knows where the project lives
                $NODE_PATH/pm2 start $NODE_PATH/npm --name "hoster-frontend" --cwd $PROJECT_ROOT -- start
            fi

            $NODE_PATH/pm2 save
            echo "Frontend Deployment Successful!"
